<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Firmar AuditorÃ­a</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
 body{
   background:linear-gradient(to right,#00416A,#0c6cbd);
   padding:25px;
   color:white;
   font-family:'Poppins',sans-serif;
 }

 .card{
   background:white;
   color:#222;
   padding:25px;
   border-radius:16px;
   max-width:500px;
   margin:auto;
   box-shadow:0 6px 20px rgba(0,0,0,.35);
   text-align:center;
 }

 canvas{
   border:2px solid #00416A;
   border-radius:10px;
   background:white;
   display:block;
   margin:auto;
 }

 button{
   width:100%;
   padding:15px;
   border:none;
   border-radius:12px;
   font-size:17px;
   margin-top:20px;
   cursor:pointer;
 }

 .btn1{
   background:#00416A;
   color:white;
 }

 .btn2{
   background:#c62828;
   color:white;
 }
</style>
</head>

<body>

<div class="card">
    <h2 style="color:#00416A;">Firma del Encargado</h2>

    <canvas id="canvas" width="350" height="200"></canvas>

    <button class="btn2" onclick="limpiar()">Limpiar firma</button>
    <button class="btn1" onclick="guardar()">Guardar AuditorÃ­a</button>
</div>

<script type="module">
import { db } from "https://lizandrolumbreras.github.io/Auditorias-sucursales1.0/firebase.js";
import { collection, addDoc, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let dibujando = false;

// Dibujar firma
canvas.addEventListener("mousedown", ()=> dibujando = true);
canvas.addEventListener("mouseup", ()=> { dibujando = false; ctx.beginPath(); });
canvas.addEventListener("mousemove", (e)=>{
    if(!dibujando) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
});

window.limpiar = ()=>{
    ctx.clearRect(0,0,350,200);
};


// ðŸ”¥ GUARDAR TODO EN FIRESTORE
window.guardar = async()=>{

    const sucursal      = localStorage.getItem("aud_sucursal");
    const nombre        = localStorage.getItem("aud_nombre");
    const fecha         = localStorage.getItem("aud_fecha");
    const usuario       = localStorage.getItem("aud_usuario");   // ðŸ”¥ AGREGADO

    const inventario    = JSON.parse(localStorage.getItem("aud_captura"));
    const caducidades   = JSON.parse(localStorage.getItem("aud_caducidades"));
    const devoluciones  = JSON.parse(localStorage.getItem("aud_devoluciones"));
    const incidencias   = localStorage.getItem("aud_incidencias");
    const sugerencias   = localStorage.getItem("aud_sugerencias");

    const firma = canvas.toDataURL();

    const data = {
        sucursal,
        nombre,
        usuario,       // ðŸ”¥ AGREGADO
        fecha,
        creadoEn: serverTimestamp(),
        firma,

        // SUBMODULOS
        inventario,
        caducidades,
        devoluciones,
        incidencias,
        sugerencias
    };

    await addDoc(
        collection(db, `auditorias/${sucursal}/auditorias_registros`),
        data
    );

    // Limpiar memoria temporal
    localStorage.removeItem("aud_captura");
    localStorage.removeItem("aud_caducidades");
    localStorage.removeItem("aud_devoluciones");
    localStorage.removeItem("aud_incidencias");
    localStorage.removeItem("aud_sugerencias");

    window.location = "gracias.html";
};

</script>

</body>
</html>
