<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Auditoría – Firma</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
 body{
   background:linear-gradient(to right,#00416A,#0c6cbd);
   padding:20px; color:white;
   font-family:'Poppins',sans-serif;
 }

 .card{
   background:white; color:#222;
   padding:20px; border-radius:14px;
   max-width:450px; margin:auto;
   box-shadow:0 4px 20px rgba(0,0,0,.35);
 }

 button{
   width:100%; padding:15px;
   background:#00416A; color:white;
   border:none; border-radius:10px;
   margin-top:20px; font-size:17px;
 }
</style>
</head>

<body>

<div class="card">
  <h2 style="text-align:center;color:#00416A;">Firma del encargado</h2>

  <canvas id="canvas" width="350" height="200" style="border:2px solid #00416A;border-radius:10px;"></canvas>

  <button onclick="limpiar()">Limpiar</button>
  <button onclick="guardar()">Guardar Auditoría</button>
</div>

<script type="module">
import { db } from "./firebase.js";
import { doc, collection, addDoc, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let dib=false;

canvas.addEventListener("mousedown",()=>dib=true);
canvas.addEventListener("mouseup",()=>{dib=false;ctx.beginPath();});
canvas.addEventListener("mousemove",e=>{
    if(!dib) return;
    const r=canvas.getBoundingClientRect();
    ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="#000";
    ctx.lineTo(e.clientX-r.left,e.clientY-r.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
});

window.limpiar=()=> ctx.clearRect(0,0,350,200);

window.guardar=async ()=>{
    const suc = localStorage.getItem("aud_sucursal");
    const firma = canvas.toDataURL();

    const data={
        sucursal: suc,
        nombre: localStorage.getItem("aud_nombre"),
        fecha: localStorage.getItem("aud_fecha"),
        captura: JSON.parse(localStorage.getItem("aud_captura")),
        firma,
        creadoEn: serverTimestamp()
    };

    await addDoc(collection(db,`auditorias/${suc}/auditorias_registros`), data);

    window.location="gracias.html";
};
</script>

</body>
</html>
