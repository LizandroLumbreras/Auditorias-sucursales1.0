<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Detalle de Auditoría</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

:root{
    --azul1:#00416A;
    --azul2:#0c6cbd;
}

/* FONDO */
body{
    margin:0;
    font-family:'Poppins',sans-serif;
    min-height:100vh;
    background: linear-gradient(140deg, var(--azul1), var(--azul2));
    padding:20px 20px 60px 20px;
    color:white;
}

/* MARCA DE AGUA */
.watermark{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:600px;
    opacity:0.07;
    pointer-events:none;
}

/* TITULO */
h2{
    text-align:center;
    font-size:32px;
    margin-bottom:20px;
    text-shadow:0 4px 10px rgba(0,0,0,.35);
}

/* CARD CONTENEDORES */
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(12px);
    padding:20px;
    border-radius:14px;
    margin:20px auto;
    max-width:900px;
    box-shadow:0 8px 28px rgba(0,0,0,.35);
}

.section-title{
    font-size:24px;
    font-weight:600;
    margin-top:40px;
}

/* TABLAS */
.tabla-aud{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    background:white;
    color:#222;
    border-radius:10px;
    overflow:hidden;
}

.tabla-aud th{
    background:#00416A;
    color:white;
    padding:10px;
}

.tabla-aud td{
    padding:8px;
    text-align:center;
    border-bottom:1px solid #ddd;
}

/* BOTON PDF */
#btnPDF{
    width:100%;
    max-width:300px;
    padding:15px;
    background:white;
    color:#00416A;
    font-weight:600;
    border:none;
    border-radius:12px;
    margin:25px auto;
    display:block;
    cursor:pointer;
    font-size:17px;
    box-shadow:0 5px 12px rgba(0,0,0,.25);
}

#btnPDF:hover{
    background:#e1e1e1;
}
</style>
</head>

<body>

<img src="logo_proveedora.webp" class="watermark">

<h2>Detalle de Auditoría</h2>

<div id="contenido"></div>

<h3 class="section-title">Inventario Fijo</h3>
<div id="invFijo"></div>

<h3 class="section-title">Inventario Aleatorio</h3>
<div id="invAlea"></div>

<h3 class="section-title">Caducidades</h3>
<div id="cadList" class="card"></div>

<h3 class="section-title">Devoluciones</h3>
<div id="devList" class="card"></div>

<h3 class="section-title">Incidencias</h3>
<div id="incList" class="card"></div>

<h3 class="section-title">Sugerencias</h3>
<div id="sugList" class="card"></div>

<h3 class="section-title">Firma del Encargado</h3>
<div id="firmaDiv" class="card"></div>

    <h3 class="section-title">Cálculo de Inventario Teórico (Admin)</h3>

<div class="card" id="bloqueTeorico">
  <p><b>1) Subir ventas (TXT |):</b></p>
  <input type="file" id="fileVentas" accept=".txt"><br><br>

  <p><b>2) Subir transferencias (TXT | – solo entradas):</b></p>
  <input type="file" id="fileTrans" accept=".txt"><br><br>

  <button id="btnCalcular">Calcular inventario teórico</button>

  <p id="msgTeorico" style="margin-top:10px;font-weight:600;"></p>
</div>
<h3 class="section-title">Segunda Visita — Inventario Físico 2</h3>

<div class="card" id="bloqueFisico2">
  <p>Captura las cantidades físicas observadas en la segunda visita.</p>
  <div id="tablaFisico2"></div>

  <button id="btnComparar">Comparar y cerrar auditoría</button>
  <p id="msgCierre" style="margin-top:10px;font-weight:600;"></p>
</div>

<button id="btnPDF">Generar PDF</button>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Autorización */
if(localStorage.getItem("admin_login")!=="true"){
    window.location="admin_login.html";
}

const id = localStorage.getItem("admin_last_id");
const sucursal = localStorage.getItem("admin_last_sucursal");

/* ============================================
   CARGAR DETALLE
   ============================================ */
async function cargarDetalle(){

    const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
    const snap = await getDoc(regRef);

    if(!snap.exists()){
        document.getElementById("contenido").innerHTML =
            "<div class='card'>Registro no encontrado</div>";
        return;
    }

    const x = snap.data();
    // Mostrar Físico 2 solo cuando el teórico ya esté calculado
if(x.estado === "teorico_calculado"){
    document.getElementById("tablaFisico2").innerHTML =
        tablaFisico2Editable(x.inventario_teorico || []);
}else{
    const b2 = document.getElementById("bloqueFisico2");
    if(b2) b2.style.display = "none";
}


    if(x.estado === "teorico_calculado" || x.estado === "validado"){
    const b = document.getElementById("bloqueTeorico");
    if(b) b.style.display = "none";
}

    /* DATOS GENERALES */
    document.getElementById("contenido").innerHTML = `
        <div class="card">
            <h3>Datos Generales</h3>
            <p><b>Nombre encargado:</b> ${x.nombre}</p>
            <p><b>Usuario:</b> ${x.usuario}</p>
            <p><b>Sucursal:</b> ${sucursal}</p>
            <p><b>Fecha:</b> ${x.fecha}</p>
        </div>
    `;

    /* INVENTARIO */
    const fijos = x.inventario.filter(p => p.id.startsWith("fijo_"));
    const alea = x.inventario.filter(p => !p.id.startsWith("fijo_"));

    document.getElementById("invFijo").innerHTML = generarTabla(fijos);
    document.getElementById("invAlea").innerHTML = generarTabla(alea);

/* CADUCIDADES — MUESTRA PREGUNTAS + RESPUESTAS */
let cad = x.caducidades;

if (!cad) {
    document.getElementById("cadList").innerHTML = "Sin información";
} else {
    const preguntas = [
        "1. Revisa caducidades de CREMAS y ADEREZOS y apúntalas aquí:",
        "2. Revisa caducidades de BIG COLA y LÍQUIDOS:",
        "3. Revisa caducidades de NUTRI LECHE y LÁCTEOS:",
        "4. ¿Algún otro producto con caducidad próxima?",
        "5. ¿Detectaste producto hinchado, dañado o con mala presentación?"
    ];

    let html = "";

    html += `<b>Fechas de caducidad registradas y observaciones:</b><br><br>`;

    html += preguntas
        .map((p, i) => {
            const key = "p" + (i + 1);
            return `<p><b>${p}</b><br>${cad[key] || "Sin respuesta"}</p>`;
        })
        .join("");

    document.getElementById("cadList").innerHTML = html;
}

    /* DEVOLUCIONES */
    document.getElementById("devList").innerHTML =
        x.devoluciones?.length
            ? x.devoluciones.map(d => `
                <p><b>${d.descripcion}</b><br>
                Código: ${d.codigo}<br>
                Cantidad: ${d.cantidad}<br>
                Motivo: ${d.motivo}</p>
            `).join("")
            : "Sin devoluciones";

    /* INCIDENCIAS */
    document.getElementById("incList").innerHTML = x.incidencias || "Sin incidencias";

    /* SUGERENCIAS */
    document.getElementById("sugList").innerHTML = x.sugerencias || "Sin sugerencias"

    /* FIRMA */
    document.getElementById("firmaDiv").innerHTML =
        `<img src="${x.firma}" style="width:250px; border:2px solid white; border-radius:8px;">`;

}

/* FORMADOR DE TABLA */
function generarTabla(arr){
    if(!arr.length) return "<p>Sin datos</p>";

    return `
        <table class="tabla-aud">
            <tr>
                <th>Código</th>
                <th>Producto</th>
                <th>Cantidad</th>
            </tr>
            ${arr.map(p => `
                <tr>
                    <td>${p.codigo}</td>
                    <td>${p.concepto}</td>
                    <td>${p.cantidad}</td>
                </tr>`).join("")}
        </table>
    `;
}

cargarDetalle();
function leerTXT(file){
    return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}
function tablaFisico2Editable(invTeorico){
    if(!invTeorico.length) return "<p>Sin inventario teórico</p>";

    return `
      <table class="tabla-aud">
        <tr>
          <th>Código</th>
          <th>Producto</th>
          <th>Teórico</th>
          <th>Físico 2</th>
        </tr>
        ${invTeorico.map(p=>`
          <tr>
            <td>${p.codigo}</td>
            <td>${p.concepto}</td>
            <td>${p.teorico}</td>
            <td>
              <input type="number" step="any"
                     data-codigo="${p.codigo}"
                     placeholder="0">
            </td>
          </tr>
        `).join("")}
      </table>
    `;
}

// Espera formato: CODIGO|CANTIDAD (una línea por registro)
function parsearPipeTXT(texto){
    const mapa = {};
    texto.split(/\r?\n/).forEach(l=>{
        if(!l.trim()) return;
        const [codigo, cant] = l.split("|").map(s=>s.trim());
        const n = Number(cant);
        if(codigo && !isNaN(n)){
            mapa[codigo] = (mapa[codigo] || 0) + n;
        }
    });
    return mapa;
}
document.getElementById("btnCalcular").onclick = async ()=>{
    const msg = document.getElementById("msgTeorico");
    msg.textContent = "Procesando...";

    const fVentas = document.getElementById("fileVentas").files[0];
    const fTrans  = document.getElementById("fileTrans").files[0];

    if(!fVentas || !fTrans){
        msg.textContent = "Sube ambos archivos TXT.";
        return;
    }

    try{
        const [txtV, txtT] = await Promise.all([
            leerTXT(fVentas),
            leerTXT(fTrans)
        ]);

        const ventasMap = parsearPipeTXT(txtV);
        const transMap  = parsearPipeTXT(txtT); // SOLO ENTRADAS

        // Releer auditoría actual
        const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
        const snap = await getDoc(regRef);
        if(!snap.exists()){
            msg.textContent = "Auditoría no encontrada.";
            return;
        }

        const data = snap.data();
        const invFisico = data.inventario || [];

        // Calcular teórico por código
        const inventario_teorico = invFisico.map(p=>{
            const v = ventasMap[p.codigo] || 0;
            const t = transMap[p.codigo] || 0;
            const teorico = Number(p.cantidad || 0) - v + t;
            return {
                codigo: p.codigo,
                concepto: p.concepto,
                fisico_1: Number(p.cantidad || 0),
                ventas: v,
                transferencias: t,
                teorico
            };
        });

        // Guardar resultados
        await updateDoc(regRef, {
            ventas: ventasMap,
            transferencias: transMap,
            inventario_teorico,
            estado: "teorico_calculado",
            teorico_calculado_en: new Date().toISOString()
        });

        msg.textContent = "Inventario teórico calculado y guardado.";
    }catch(err){
        console.error(err);
        msg.textContent = "Error al procesar archivos.";
    }
};
    document.getElementById("btnComparar").onclick = async ()=>{
    const msg = document.getElementById("msgCierre");
    msg.textContent = "Comparando...";

    const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
    const snap = await getDoc(regRef);
    if(!snap.exists()){
        msg.textContent = "Auditoría no encontrada.";
        return;
    }

    const data = snap.data();
    const invTeorico = data.inventario_teorico || [];

    // Leer valores capturados
    const inputs = document.querySelectorAll(
        '#tablaFisico2 input[data-codigo]'
    );

    const fisico2Map = {};
    inputs.forEach(i=>{
        const codigo = i.dataset.codigo;
        const val = Number(i.value);
        fisico2Map[codigo] = isNaN(val) ? 0 : val;
    });

    const inventario_fisico_2 = invTeorico.map(p=>({
        codigo: p.codigo,
        concepto: p.concepto,
        cantidad: fisico2Map[p.codigo] || 0
    }));

    const diferencias = invTeorico.map(p=>{
        const f2 = fisico2Map[p.codigo] || 0;
        return {
            codigo: p.codigo,
            concepto: p.concepto,
            teorico: p.teorico,
            fisico_2: f2,
            diferencia: f2 - p.teorico
        };
    });

    await updateDoc(regRef, {
        inventario_fisico_2,
        diferencias,
        estado: "validado",
        validado_en: new Date().toISOString()
    });

    msg.textContent = "Auditoría cerrada correctamente.";
    document.getElementById("btnComparar").disabled = true;
};

/* ============================================================
      GENERAR PDF PROFESIONAL — PDF REAL (NO IMAGEN)
============================================================ */
document.getElementById("btnPDF").onclick = async ()=>{

    const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
    const snap = await getDoc(regRef);
    if (!snap.exists()) return;

    const x = snap.data();

    /* ===========================
       CONVERTIR LOGO A BASE64
    ============================ */

    async function getBase64Image(url){
        const res = await fetch(url);
        const blob = await res.blob();
        return new Promise(resolve=>{
            const reader = new FileReader();
            reader.onloadend = ()=> resolve(reader.result);
            reader.readAsDataURL(blob);
        });
    }

    // IMPORTANTE → CON ./ PARA QUE CARGUE BIEN EN GITHUB PAGES
  const logoBase64 = await getBase64Image("./logo_proveedora.png");

    // Firma ya viene en base64, solo limpiamos:
    const firmaBase64 = (x.firma || "").trim();

    if (!firmaBase64.startsWith("data:image")) {
        alert("La firma no es una imagen válida.");
        return;
    }

    /* =======================
       TABLAS PARA EL PDF
    ======================== */

    function tablaInventario(arr) {
        return {
            table: {
                widths: ["20%", "60%", "20%"],
                body: [
                    [
                        {text:"Código", bold:true},
                        {text:"Producto", bold:true},
                        {text:"Cantidad", bold:true}
                    ],
                    ...arr.map(p => [
                        p.codigo,
                        p.concepto,
                        p.cantidad.toString()
                    ])
                ]
            },
            margin:[0,10,0,10]
        };
    }

    function tablaDevoluciones(arr){
        if(!arr?.length) return {text:"Sin devoluciones", margin:[0,5]};

        return {
            table:{
                widths:["30%","20%","20%","30%"],
                body:[
                    [
                        {text:"Descripción", bold:true},
                        {text:"Código", bold:true},
                        {text:"Cantidad", bold:true},
                        {text:"Motivo", bold:true}
                    ],
                    ...arr.map(d=>[
                        d.descripcion,
                        d.codigo,
                        d.cantidad.toString(),
                        d.motivo
                    ])
                ]
            },
            margin:[0,10]
        };
    }

/* === CADUCIDADES CON PREGUNTAS === */

const preguntasCad = [
    "1. Revisa caducidades de CREMAS y ADEREZOS:",
    "2. Revisa caducidades de BIG COLA y LÍQUIDOS:",
    "3. Revisa caducidades de NUTRI LECHE y LÁCTEOS:",
    "4. ¿Algún otro producto con caducidad próxima?",
    "5. ¿Detectaste producto hinchado, dañado o con mala presentación?"
];

let cadArray = [];

if (x.caducidades) {

    cadArray.push({text:"Caducidades revisadas:", bold:true, margin:[0,0,0,8]});

    preguntasCad.forEach((p, idx) => {
        const key = "p" + (idx + 1);
        cadArray.push({
            text: `${p}\n${x.caducidades[key] || "Sin respuesta"}`,
            margin:[0,5]
        });
    });

} else {
    cadArray.push({text:"Sin información de caducidades."});
}


    /* ===========================
        DOCUMENTO PDF
    ============================ */
    const docDefinition = {
        pageSize: "LETTER",
        pageMargins: [40, 50, 40, 50],

        content: [

            /* ENCABEZADO */
            {
                image: logoBase64,
                width: 120,
                alignment: "center",
                margin:[0,0,0,10]
            },
            {
                text:"REPORTE DE AUDITORÍA",
                fontSize:20,
                bold:true,
                alignment:"center",
                margin:[0,0,0,20]
            },

            /* DATOS GENERALES */
            {
                text:"Datos generales",
                style:"titulo"
            },
            {
                table:{
                    widths:["30%","70%"],
                    body:[
                        ["Encargado:", x.nombre],
                        ["Usuario:", x.usuario],
                        ["Sucursal:", sucursal],
                        ["Fecha:", x.fecha]
                    ]
                },
                margin:[0,10,0,20]
            },

            /* INVENTARIO FIJO */
            {text:"Inventario Fijo", style:"titulo"},
            tablaInventario( x.inventario.filter(p=>p.id.startsWith("fijo_")) ),

            /* INVENTARIO ALEATORIO */
            {text:"Inventario Aleatorio", style:"titulo"},
            tablaInventario( x.inventario.filter(p=>!p.id.startsWith("fijo_")) ),

            /* CADUCIDADES + PREGUNTAS */
            {text:"Caducidades y Preguntas", style:"titulo"},
            ...cadArray,
            {text:"\n"},

            /* DEVOLUCIONES */
            {text:"Devoluciones", style:"titulo"},
            tablaDevoluciones(x.devoluciones),

            /* INCIDENCIAS */
            {text:"Incidencias", style:"titulo"},
            {text: x.incidencias || "Sin incidencias", margin:[0,10]},

            /* SUGERENCIAS */
            {text:"Sugerencias", style:"titulo"},
            {text: x.sugerencias || "Sin sugerencias", margin:[0,10]},

            /* FIRMA */
            {text:"Firma del encargado", style:"titulo", margin:[0,20,0,10]},
            {
                image: firmaBase64,
                width: 220,
                margin:[0,10]
            }
        ],

        styles:{
            titulo:{
                fontSize:16,
                bold:true,
                margin:[0,15,0,5]
            }
        }
    };

    pdfMake.createPdf(docDefinition).download(`Auditoria_${sucursal}_${x.fecha}.pdf`);
};
</script>

</body>
</html>
