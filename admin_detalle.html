<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Detalle de Auditoría</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

:root{
    --azul1:#00416A;
    --azul2:#0c6cbd;
    --blanco:#ffffff;
}

/* FONDO */
body{
    margin:0;
    font-family:'Poppins',sans-serif;
    min-height:100vh;
    background: linear-gradient(140deg, var(--azul1), var(--azul2));
    padding:20px;
    padding-bottom:60px;
    position:relative;
    color:white;
}

/* MARCA DE AGUA */
.watermark{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:600px;
    opacity:0.07;
    pointer-events:none;
    z-index:0;
}

/* TITULO */
h2{
    text-align:center;
    font-size:32px;
    font-weight:600;
    margin-top:15px;
    margin-bottom:25px;
    color:white;
    text-shadow:0 4px 10px rgba(0,0,0,.35);
}

/* TARJETAS */
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(14px);
    padding:22px;
    border-radius:16px;
    margin:20px auto;
    max-width:900px;
    box-shadow:0 8px 28px rgba(0,0,0,.35);
    animation:fadeUp .6s ease;
    color:white;
}

.card h3{
    margin-top:0;
    font-size:22px;
    color:white;
}

/* TITULOS SECCION */
.section-title{
    font-size:24px;
    font-weight:600;
    margin-top:40px;
    text-shadow:0 3px 10px rgba(0,0,0,.30);
}

/* LISTA INVENTARIO */
#invList.grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    gap:18px;
    margin-top:18px;
}

.card-item{
    background:rgba(255,255,255,0.18);
    backdrop-filter:blur(12px);
    padding:16px;
    border-radius:14px;
    box-shadow:0 5px 18px rgba(0,0,0,.30);
    font-size:15px;
    color:white;
    animation:fadeUp .6s ease;
}

/* ANIMACIÓN */
@keyframes fadeUp{
    from{ opacity:0; transform:translateY(20px); }
    to{ opacity:1; transform:translateY(0px); }
}
/* NUEVA TABLA INVENTARIO */
.tabla-aud {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    background:white;
    color:#222;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
}

.tabla-aud th {
    background:#00416A;
    color:white;
    padding:10px;
    font-size:14px;
}

.tabla-aud td {
    padding:8px;
    border-bottom:1px solid #ddd;
    text-align:center;
    font-size:14px;
}

.tabla-seccion {
    background:rgba(255,255,255,0.20);
    color:white;
    font-weight:bold;
    padding:6px 10px;
    margin-top:18px;
    margin-bottom:6px;
    border-radius:10px;
}
</style>

</head>

<body>

<!-- Marca de agua -->
<img src="logo_proveedora.webp" class="watermark">

<h2>Detalle de Auditoría</h2>

<div id="contenido"></div>

<!-- Inventario -->
<h3 class="section-title">Inventario</h3>
<div id="invList" class="grid"></div>

<!-- Caducidades -->
<h3 class="section-title">Caducidades</h3>
<div id="cadList" class="card"></div>

<!-- Devoluciones -->
<h3 class="section-title">Devoluciones</h3>
<div id="devList" class="card"></div>

<!-- Incidencias -->
<h3 class="section-title">Incidencias</h3>
<div id="incList" class="card"></div>

<!-- Sugerencias -->
<h3 class="section-title">Sugerencias</h3>
<div id="sugList" class="card"></div>

<h3 class="section-title">Preguntas y Respuestas</h3>
<div id="qaList" class="card"></div>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Validación login */
if(localStorage.getItem("admin_login")!=="true"){
    window.location="admin_login.html";
}

const id = localStorage.getItem("admin_last_id");
const sucursal = localStorage.getItem("admin_last_sucursal");

/* ===========================================================
   CARGAR DETALLE
   =========================================================== */
async function cargarDetalle(){

    if(!sucursal){
        document.getElementById("contenido").innerHTML =
            "<div class='card'>No se encontró la sucursal.</div>";
        return;
    }

    const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
    const regSnap = await getDoc(regRef);

    if(!regSnap.exists()){
        document.getElementById("contenido").innerHTML =
            "<div class='card'>No se encontró el registro.</div>";
        return;
    }

    const x = regSnap.data();

    document.getElementById("contenido").innerHTML = `
        <div class="card">
            <h3>Datos Generales</h3>
            <p><b>Nombre:</b> ${x.nombre}</p>
            <p><b>Usuario:</b> ${x.usuario || "No registrado"}</p>
            <p><b>Sucursal:</b> ${sucursal}</p>
            <p><b>Fecha:</b> ${x.fecha}</p>
        </div>
    `;

    /* Inventario */
    renderInventario(x.inventario || []);

    /* Caducidades */
    document.getElementById("cadList").innerHTML =
        x.caducidades
            ? Object.values(x.caducidades).join("<br><br>")
            : "Sin información";

    /* Devoluciones */
    document.getElementById("devList").innerHTML =
        x.devoluciones && x.devoluciones.length > 0
            ? x.devoluciones.map(d=>`
                <b>${d.descripcion}</b><br>
                Código: ${d.codigo}<br>
                Cantidad: ${d.cantidad}<br>
                Motivo: ${d.motivo}<br><br>
            `).join("")
            : "Sin devoluciones";

    /* Incidencias */
    document.getElementById("incList").innerHTML =
        x.incidencias || "Sin incidencias";

    /* Sugerencias */
    document.getElementById("sugList").innerHTML =
        x.sugerencias || "Sin sugerencias";

    /* ===========================================================
       ✔ PREGUNTAS Y RESPUESTAS
       =========================================================== */
    if (x.preguntas && x.preguntas.length > 0) {
        document.getElementById("qaList").innerHTML =
            x.preguntas.map(q => `
                <p><b>${q.p}</b><br>→ ${q.r}</p>
            `).join("");
    } else {
        document.getElementById("qaList").innerHTML =
            "Sin preguntas registradas";
    }
}

/* ===========================================================
   RENDER INVENTARIO
   =========================================================== */
function renderInventario(lista){

    const invDiv = document.getElementById("invList");
    invDiv.innerHTML = "";

    const fijos = lista.filter(p => p.id && p.id.startsWith("fijo_"));
    const aleatorios = lista.filter(p => !p.id || !p.id.startsWith("fijo_"));

    /* Fijos */
    invDiv.innerHTML += `
        <h3 class="section-title" style="margin-top:10px;">Inventario Fijo</h3>
    `;

    if (fijos.length > 0) {
        invDiv.innerHTML += `
            <table class="tabla-aud">
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                </tr>
                ${fijos.map(f => `
                    <tr>
                        <td>${f.codigo}</td>
                        <td>${f.concepto}</td>
                        <td>${f.cantidad}</td>
                    </tr>
                `).join("")}
            </table>
        `;
    } else {
        invDiv.innerHTML += `<p style="opacity:.8;">Sin productos fijos capturados.</p>`;
    }

    /* Aleatorios */
    invDiv.innerHTML += `
        <h3 class="section-title" style="margin-top:40px;">Inventario Aleatorio</h3>
    `;

    if (aleatorios.length > 0) {
        invDiv.innerHTML += `
            <table class="tabla-aud">
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                </tr>
                ${aleatorios.map(a => `
                    <tr>
                        <td>${a.codigo}</td>
                        <td>${a.concepto}</td>
                        <td>${a.cantidad}</td>
                    </tr>
                `).join("")}
            </table>
        `;
    } else {
        invDiv.innerHTML += `<p style="opacity:.8;">Sin productos aleatorios.</p>`;
    }
}

cargarDetalle();
</script>
</body>
</html>
