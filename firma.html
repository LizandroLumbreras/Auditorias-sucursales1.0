<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Firmar Auditoría</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

:root{
    --azul1:#00416A;
    --azul2:#0c6cbd;
    --blanco:#ffffff;
}

/* FONDO */
body{
   margin:0;
   font-family:'Poppins',sans-serif;
   min-height:100vh;
   background: linear-gradient(135deg, var(--azul1), var(--azul2));
   display:flex;
   justify-content:center;
   align-items:center;
   padding:30px 20px;
   position:relative;
   overflow:hidden;
}

/* ✔ MARCA DE AGUA */
.watermark{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:650px;
    opacity:0.10;
    pointer-events:none;
    z-index:0;
}

/* TARJETA */
.card{
   width:100%;
   max-width:520px;
   background:rgba(255,255,255,0.18);
   backdrop-filter:blur(14px);
   padding:30px;
   border-radius:18px;
   box-shadow:0 8px 35px rgba(0,0,0,.25);
   text-align:center;
   color:white;
   z-index:5;
   animation: fadeUp .7s ease;
}

@keyframes fadeUp{
    from{ opacity:0; transform:translateY(25px); }
    to{ opacity:1; transform:translateY(0); }
}

/* TÍTULO */
h2{
    color:white;
    font-size:28px;
    font-weight:600;
    margin-bottom:20px;
}

/* CANVAS */
canvas{
   border:2px solid var(--azul1);
   border-radius:12px;
   background:white;
   display:block;
   margin:15px auto;
   box-shadow:0 4px 12px rgba(0,0,0,.25);
}

/* BOTONES */
button{
   width:100%;
   padding:16px;
   border:none;
   border-radius:12px;
   font-size:17px;
   font-weight:600;
   cursor:pointer;
   margin-top:18px;
   transition:.25s ease;
   box-shadow:0 5px 12px rgba(0,0,0,.25);
}

.btn1{
   background:white;
   color:var(--azul1);
}
.btn1:hover{
   background:#ececec;
   transform:translateY(-2px);
}

.btn2{
   background:#c62828;
   color:white;
}
.btn2:hover{
   background:#e53935;
   transform:translateY(-2px);
}

</style>
</head>

<body>

<!-- ✔ MARCA DE AGUA -->
<img src="logo_proveedora.webp" class="watermark">

<div class="card">

    <h2>Firma del Encargado</h2>

    <canvas id="canvas" width="350" height="200"></canvas>

    <button class="btn2" onclick="limpiar()">Limpiar firma</button>
    <button class="btn1" onclick="guardar()">Guardar Auditoría</button>

</div>

<script type="module">
import { db } from "https://lizandrolumbreras.github.io/Auditorias-sucursales1.0/firebase.js";
import { collection, addDoc, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let dibujando = false;

/* =============== DIBUJAR FIRMA =============== */
canvas.addEventListener("mousedown", ()=> dibujando = true);
canvas.addEventListener("mouseup", ()=> { dibujando = false; ctx.beginPath(); });
canvas.addEventListener("mousemove", (e)=>{
    if(!dibujando) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
});

/* LIMPIAR */
window.limpiar = ()=>{
    ctx.clearRect(0,0,350,200);
};

/* =============== GUARDAR AUDITORÍA COMPLETA =============== */
window.guardar = async()=>{

    const sucursal      = localStorage.getItem("aud_sucursal");
    const nombre        = localStorage.getItem("aud_nombre");
    const fecha         = localStorage.getItem("aud_fecha");
    const usuario       = localStorage.getItem("aud_usuario");

    const inventario    = JSON.parse(localStorage.getItem("aud_captura"));
    const caducidades   = JSON.parse(localStorage.getItem("aud_caducidades"));
    const devoluciones  = JSON.parse(localStorage.getItem("aud_devoluciones"));
    const incidencias   = localStorage.getItem("aud_incidencias");
    const sugerencias   = localStorage.getItem("aud_sugerencias");

    const firma = canvas.toDataURL();

    const data = {
        sucursal,
        nombre,
        usuario,
        fecha,
        creadoEn: serverTimestamp(),
        firma,
        inventario,
        caducidades,
        devoluciones,
        incidencias,
        sugerencias
    };

    await addDoc(
        collection(db, `auditorias/${sucursal}/auditorias_registros`),
        data
    );

    // LIMPIAR
    localStorage.removeItem("aud_captura");
    localStorage.removeItem("aud_caducidades");
    localStorage.removeItem("aud_devoluciones");
    localStorage.removeItem("aud_incidencias");
    localStorage.removeItem("aud_sugerencias");

    window.location = "gracias.html";
};
</script>

</body>
</html>
