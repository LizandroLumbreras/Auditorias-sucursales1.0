<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Auditor√≠a ‚Äì Inventario Aleatorio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

:root{
    --azul1:#00416A;
    --azul2:#0c6cbd;
    --blanco:#ffffff;
}

/* FONDO GENERAL */
body{
    margin:0;
    font-family:'Poppins',sans-serif;
    min-height:100vh;
    padding:0;
    background: linear-gradient(135deg, var(--azul1), var(--azul2));
    position:relative;
    overflow-x:hidden;
}

/* ‚úî NUEVA MARCA DE AGUA EST√ÅTICA */
.watermark{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:600px;
    opacity:0.10;         /* Muy tenue */
    z-index:0;
    pointer-events:none;  /* No estorba clics */
}

/* TARJETA PRINCIPAL */
.contenedor{
    width:95%;
    max-width:900px;
    margin:40px auto;
    background:rgba(255,255,255,0.18);
    backdrop-filter: blur(14px);
    padding:25px;
    border-radius:20px;
    box-shadow:0 8px 35px rgba(0,0,0,.25);
    z-index:5;
    position:relative;
    animation: fadeUp .7s ease;
}

@keyframes fadeUp{
    from{ opacity:0; transform:translateY(25px); }
    to{ opacity:1; transform:translateY(0); }
}

h2{
    text-align:center;
    font-size:30px;
    color:white;
    font-weight:600;
    margin-bottom:25px;
    letter-spacing:1px;
}

/* TARJETAS DE PRODUCTO */
.item{
   background:rgba(255,255,255,0.90);
   backdrop-filter:blur(8px);
   color:#222;
   padding:15px;
   border-radius:14px;
   box-shadow:0 4px 16px rgba(0,0,0,.25);
   margin-bottom:15px;
   transition:.3s;
}
.item:hover{
    transform:scale(1.02);
}

/* INPUT CANTIDADES */
input{
   width:95%;
   padding:14px;
   border-radius:12px;
   border:none;
   outline:none;
   font-size:15px;
   margin-top:10px;
   background:rgba(255,255,255,0.85);
   color:#333;
   box-shadow:inset 0 2px 6px rgba(0,0,0,.15);
}

/* BOT√ìN FINALIZAR */
button{
   width:100%;
   padding:16px;
   background:white;
   color:var(--azul1);
   border:none;
   border-radius:12px;
   font-size:18px;
   font-weight:600;
   cursor:pointer;
   margin-top:25px;
   box-shadow:0 5px 12px rgba(0,0,0,.25);
   transition:.25s ease;
}
button:hover{
    background:#e8e8e8;
    transform:translateY(-2px);
}

h3{
    color:white;
    margin-top:40px;
    margin-bottom:10px;
    font-size:22px;
}

</style>
</head>

<body>

<!-- ‚úî MARCA DE AGUA EN LUGAR DEL LOGO ANIMADO -->
<img src="logo_proveedora.webp" class="watermark">

<div class="contenedor">

<h2 id="tituloAuditoria">Captura de Auditor√≠a</h2>

<div id="lista"></div>

<button onclick="finalizar()">Finalizar</button>

</div> <!-- FIN CONTENEDOR -->
    
<script type="module">
const modoFisico2 = localStorage.getItem("aud_modo") === "fisico_2";
    if (modoFisico2) {
    document.getElementById("tituloAuditoria").textContent =
        "Revisi√≥n F√≠sica 2 (Validaci√≥n)";
}

import { db } from "https://lizandrolumbreras.github.io/Auditorias-sucursales1.0/firebase.js";
import { 
    collection, 
    getDocs, 
    doc, 
    getDoc,
    query,
    where
} 

  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    async function obtenerTopMovimientos(){

  const hace30Dias = new Date();
hace30Dias.setDate(hace30Dias.getDate() - 30);

const q = query(
    collection(db,"ventas_rutav2"),
    where("fecha", ">=", hace30Dias)
);

const snap = await getDocs(q);
  const acumulado = {};

  snap.forEach(doc=>{
    const data = doc.data();
    const detalles = data.detalle || [];

    detalles.forEach(item=>{
     const codigo = String(item.codigo);
      const cantidad = Number(item.cantidad || 0);

      if(!acumulado[codigo]){
        acumulado[codigo] = 0;
      }

      acumulado[codigo] += cantidad;
    });
  });

const ordenados = Object.entries(acumulado)
  .sort((a,b)=> b[1] - a[1]);

return ordenados.map(x => x[0]);

}


const lista = document.getElementById("lista");

/* ---------- LISTA FIJA ---------- */
const FIJOS_MANUALES = [
  { codigo: "75035259", concepto: "MARLBORO BLANCO 100" },
  { codigo: "75068738", concepto: "MARLBORO BLANCO DURO" },
  { codigo: "75068745", concepto: "MARLBORO BLANCO SUAVE" },
  { codigo: "75021597", concepto: "MARLBORO ROJO 100" },
  { codigo: "75001322", concepto: "MARLBORO ROJO DURO" },
  { codigo: "75001315", concepto: "MARLBORO ROJO SUAVE" },
  { codigo: "75025271", concepto: "MARLBORO FUSION SUMER" },
  { codigo: "75068776", concepto: "BENSON DORADO" },
  { codigo: "75016777", concepto: "BENSON MENTHOL" },
  { codigo: "75068783", concepto: "MARLBORO RUBI" },
  { codigo: "75071295", concepto: "PALL MALL ALASKA" },
  { codigo: "8346917", concepto: "PALL MALL BLANCO" },
  { codigo: "75064648", concepto: "PALL MALL MYKONOS PEPINO" },
  { codigo: "75052836", concepto: "PALL MALL TOKYO" },
  { codigo: "75046521", concepto: "LUCKY STRIKE" },
  { codigo: "75031053", concepto: "MARLBORO ICE XPRESS" },
  { codigo: "75018627", concepto: "BENSON MENTHOL LIGTH" },
  { codigo: "75027766", concepto: "PALL MALL XL ROJO" },
  { codigo: "1247", concepto: "CELOFAN ROJO" },
  { codigo: "2229", concepto: "CELOFAN AMARILLO" },
  { codigo: "1248", concepto: "CELOFAN BLANCO" },
  { codigo: "1249", concepto: "NUEZ PEDAZO" },
  { codigo: "1250", concepto: "NUEZ ENTERA" },
  { codigo: "230001", concepto: "NUEZ GRANILLO" },
  { codigo: "40", concepto: "CHILE JAPONES" }
];

/* ---------- CONFIG FIRESTORE ---------- */
async function obtenerConfig(){
    const ref = doc(db,"config","auditorias");
    const snap = await getDoc(ref);
    return snap.exists()? snap.data() : { renovarCadaDias:7 };
}

function debeRenovar(fecha,dias){
    if(!fecha) return true;
    const ultima = new Date(fecha);
    const hoy    = new Date();
    return ((hoy - ultima) / (1000*60*60*24)) >= dias;
}

/* ---------- FUNCI√ìN PRINCIPAL ---------- */
async function cargarProductos(){

    const cfg = await obtenerConfig();

    const guardado = JSON.parse(localStorage.getItem("aud_aleatorios"));
    const fecha    = localStorage.getItem("aud_aleatorios_fecha");

    let aleatorios;

    if(!guardado || debeRenovar(fecha,cfg.renovarCadaDias)){

        // 1Ô∏è‚É£ Traer productos activos
        const snap = await getDocs(collection(db,"productos"));
        let activos=[];

        snap.forEach(d=>{
            const x=d.data();
            if(x.activo===true){
                activos.push({id:d.id,...x});
            }
        });

        // 2Ô∏è‚É£ Obtener c√≥digos m√°s vendidos
        const topCodigos = await obtenerTopMovimientos();

// Crear lista de c√≥digos fijos
const codigosFijos = FIJOS_MANUALES.map(f => String(f.codigo));

// 3Ô∏è‚É£ Filtrar productos que coincidan,
// excluyendo los que ya est√°n en lista fija
aleatorios = activos.filter(p => {
    const codigo = String(p.codigoBarra);

    return topCodigos.includes(codigo) &&
           !codigosFijos.includes(codigo);
})
.sort((a,b) => {
    return topCodigos.indexOf(String(a.codigoBarra)) -
           topCodigos.indexOf(String(b.codigoBarra));
})
.slice(0,10);   // üî• AQU√ç cortas a 10 reales


        localStorage.setItem("aud_aleatorios",JSON.stringify(aleatorios));
        localStorage.setItem("aud_aleatorios_fecha", new Date().toISOString());

    }else{
        aleatorios = guardado;
    }

    const finalList = [
        ...FIJOS_MANUALES.map((p,i)=>({
            id:`fijo_${i}`,
            concepto:p.concepto,
            codigoBarra:p.codigo
        })),
        ...aleatorios
    ];

    localStorage.setItem("aud_productos",JSON.stringify(finalList));

    pintar(finalList);
}
/* ---------- PINTAR ---------- */
function pintar(data){

    lista.innerHTML="";

    lista.innerHTML+=`<h3>Inventario Fijo</h3>`;
    FIJOS_MANUALES.forEach((p,i)=>{
        lista.innerHTML+=`
            <div class="item">
                <b>${p.concepto}</b><br>
                <small>C√≥digo: ${p.codigo}</small>
                <input id="p_fijo_${i}" type="number" placeholder="Cantidad contada">
            </div>`;
    });

    lista.innerHTML+=`<h3>Inventario Aleatorio</h3>`;
    data.forEach(p=>{
        if(!p.id.startsWith("fijo_")){
            lista.innerHTML+=`
                <div class="item">
                    <b>${p.concepto}</b><br>
                    <small>C√≥digo: ${p.codigoBarra}</small>
                    <input id="p_${p.id}" type="number" placeholder="Cantidad contada">
                </div>`;
        }
    });
}

cargarProductos();

</script>

<script>
function finalizar(){
    if(confirm("¬øSeguro de continuar? Los campos vac√≠os ser√°n 0?")){
        const arr = JSON.parse(localStorage.getItem("aud_productos"));
        const cap = [];

        arr.forEach(p=>{
            const val = document.getElementById(`p_${p.id}`)?.value;
            cap.push({
                id:p.id,
                concepto:p.concepto,
                codigo:p.codigoBarra,
                cantidad:Number(val || 0)
            });
        });

        localStorage.setItem("aud_captura", JSON.stringify(cap));
        window.location="caducidades.html";
    }
}
</script>

</body>
</html>
