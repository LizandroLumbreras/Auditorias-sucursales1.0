<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Detalle de Auditoría</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

:root{
    --azul1:#00416A;
    --azul2:#0c6cbd;
}

/* FONDO */
body{
    margin:0;
    font-family:'Poppins',sans-serif;
    min-height:100vh;
    background: linear-gradient(140deg, var(--azul1), var(--azul2));
    padding:20px 20px 60px 20px;
    color:white;
}

/* MARCA DE AGUA */
.watermark{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:600px;
    opacity:0.07;
    pointer-events:none;
}

/* TITULO */
h2{
    text-align:center;
    font-size:32px;
    margin-bottom:20px;
    text-shadow:0 4px 10px rgba(0,0,0,.35);
}

/* CARD CONTENEDORES */
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(12px);
    padding:20px;
    border-radius:14px;
    margin:20px auto;
    max-width:900px;
    box-shadow:0 8px 28px rgba(0,0,0,.35);
}

.section-title{
    font-size:24px;
    font-weight:600;
    margin-top:40px;
}

/* TABLAS */
.tabla-aud{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    background:white;
    color:#222;
    border-radius:10px;
    overflow:hidden;
}

.tabla-aud th{
    background:#00416A;
    color:white;
    padding:10px;
}

.tabla-aud td{
    padding:8px;
    text-align:center;
    border-bottom:1px solid #ddd;
}

/* BOTON PDF */
#btnPDF{
    width:100%;
    max-width:300px;
    padding:15px;
    background:white;
    color:#00416A;
    font-weight:600;
    border:none;
    border-radius:12px;
    margin:25px auto;
    display:block;
    cursor:pointer;
    font-size:17px;
    box-shadow:0 5px 12px rgba(0,0,0,.25);
}

#btnPDF:hover{
    background:#e1e1e1;
}
</style>
</head>

<body>

<img src="logo_proveedora.webp" class="watermark">

<h2>Detalle de Auditoría</h2>

<div id="contenido"></div>

<h3 class="section-title">Inventario Fijo</h3>
<div id="invFijo"></div>

<h3 class="section-title">Inventario Aleatorio</h3>
<div id="invAlea"></div>

<h3 class="section-title">Caducidades</h3>
<div id="cadList" class="card"></div>

<h3 class="section-title">Devoluciones</h3>
<div id="devList" class="card"></div>

<h3 class="section-title">Incidencias</h3>
<div id="incList" class="card"></div>

<h3 class="section-title">Sugerencias</h3>
<div id="sugList" class="card"></div>

<h3 class="section-title">Preguntas y Respuestas</h3>
<div id="qaList" class="card"></div>

<h3 class="section-title">Firma del Encargado</h3>
<div id="firmaDiv" class="card"></div>

<button id="btnPDF">Generar PDF</button>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Autorización */
if(localStorage.getItem("admin_login")!=="true"){
    window.location="admin_login.html";
}

const id = localStorage.getItem("admin_last_id");
const sucursal = localStorage.getItem("admin_last_sucursal");

/* ============================================
   CARGAR DETALLE
   ============================================ */
async function cargarDetalle(){

    const regRef = doc(db, `auditorias/${sucursal}/auditorias_registros/${id}`);
    const snap = await getDoc(regRef);

    if(!snap.exists()){
        document.getElementById("contenido").innerHTML =
            "<div class='card'>Registro no encontrado</div>";
        return;
    }

    const x = snap.data();

    /* DATOS GENERALES */
    document.getElementById("contenido").innerHTML = `
        <div class="card">
            <h3>Datos Generales</h3>
            <p><b>Nombre encargado:</b> ${x.nombre}</p>
            <p><b>Usuario:</b> ${x.usuario}</p>
            <p><b>Sucursal:</b> ${sucursal}</p>
            <p><b>Fecha:</b> ${x.fecha}</p>
        </div>
    `;

    /* INVENTARIO */
    const fijos = x.inventario.filter(p => p.id.startsWith("fijo_"));
    const alea = x.inventario.filter(p => !p.id.startsWith("fijo_"));

    document.getElementById("invFijo").innerHTML = generarTabla(fijos);
    document.getElementById("invAlea").innerHTML = generarTabla(alea);

    /* CADUCIDADES */
    document.getElementById("cadList").innerHTML =
        x.caducidades ? Object.values(x.caducidades).join("<br><br>") : "Sin información";

    /* DEVOLUCIONES */
    document.getElementById("devList").innerHTML =
        x.devoluciones?.length
            ? x.devoluciones.map(d => `
                <p><b>${d.descripcion}</b><br>
                Código: ${d.codigo}<br>
                Cantidad: ${d.cantidad}<br>
                Motivo: ${d.motivo}</p>
            `).join("")
            : "Sin devoluciones";

    /* INCIDENCIAS */
    document.getElementById("incList").innerHTML = x.incidencias || "Sin incidencias";

    /* SUGERENCIAS */
    document.getElementById("sugList").innerHTML = x.sugerencias || "Sin sugerencias";

    /* PREGUNTAS */
    document.getElementById("qaList").innerHTML =
        x.preguntas?.length
            ? x.preguntas.map(p => `<p><b>${p.p}</b><br>→ ${p.r}</p>`).join("")
            : "Sin preguntas";

    /* FIRMA */
    document.getElementById("firmaDiv").innerHTML =
        `<img src="${x.firma}" style="width:250px; border:2px solid white; border-radius:8px;">`;

}

/* FORMADOR DE TABLA */
function generarTabla(arr){
    if(!arr.length) return "<p>Sin datos</p>";

    return `
        <table class="tabla-aud">
            <tr>
                <th>Código</th>
                <th>Producto</th>
                <th>Cantidad</th>
            </tr>
            ${arr.map(p => `
                <tr>
                    <td>${p.codigo}</td>
                    <td>${p.concepto}</td>
                    <td>${p.cantidad}</td>
                </tr>`).join("")}
        </table>
    `;
}

cargarDetalle();

/* ============================================================
   GENERAR PDF
   ============================================================ */
document.getElementById("btnPDF").onclick = async ()=>{

    const pdf = new jspdf.jsPDF("p","pt","letter");

    const nombreArchivo = `Auditoria_${sucursal}_${new Date().toLocaleDateString()}.pdf`;

    const contenido = document.body;

    const canvas = await html2canvas(contenido, {scale:2});
    const img = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgProps = pdf.getImageProperties(img);
    const ratio = imgProps.height / imgProps.width;
    const imgHeight = pageWidth * ratio;

    pdf.addImage(img, "PNG", 0, 0, pageWidth, imgHeight);

    pdf.save(nombreArchivo);
};

</script>

</body>
</html>
